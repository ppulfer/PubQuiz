@page "/game/play/{GameCode}/{TeamId:guid}"
@using PubQuiz.Web.Components.Game
@inject GameService GameService
@inject NavigationManager Navigation
@implements IAsyncDisposable
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<PageTitle>Playing - Pause-Quiz</PageTitle>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            @if (_currentQuestion == null)
            {
                <div class="card shadow mt-5">
                    <div class="card-body text-center py-5">
                        <div class="spinner-border text-primary mb-3" role="status"></div>
                        <h4>Waiting for next question...</h4>
                    </div>
                </div>
            }
            else if (_showingResults)
            {
                <div class="card shadow mt-4">
                    <div class="card-body text-center">
                        <h3 class="mb-4">Question @(_currentQuestionIndex + 1) Results</h3>

                        @if (_lastAnswer != null)
                        {
                            @if (_lastAnswer.IsCorrect)
                            {
                                <div class="alert alert-success fs-4">
                                    Correct! +@_lastAnswer.PointsAwarded points
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-danger fs-4">
                                    Incorrect!
                                </div>
                            }
                        }
                        else
                        {
                            <div class="alert alert-warning fs-4">
                                Time's up!
                            </div>
                        }

                        @if (_currentQuestion.Type == QuestionType.MultipleChoice)
                        {
                            <div class="alert alert-light border fs-5">
                                Correct answer: <strong>@((char)('A' + _currentQuestion.CorrectOptionIndex)) - @_currentQuestion.Options[_currentQuestion.CorrectOptionIndex]</strong>
                            </div>
                        }
                        else if (_currentQuestion.Type == QuestionType.OpenEnded || _currentQuestion.Type == QuestionType.Wordle)
                        {
                            <div class="alert alert-light border fs-5">
                                Correct answer: <strong>@_currentQuestion.CorrectAnswer</strong>
                            </div>
                        }

                        <h4 class="mt-4 mb-3">Leaderboard</h4>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Team</th>
                                    <th class="text-end">Points</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{int rank = 1;}
                                @foreach (var team in _leaderboard)
                                {
                                    <tr class="@(team.TeamId == TeamId ? "table-primary fw-bold" : "")">
                                        <td>@rank</td>
                                        <td>@team.TeamName</td>
                                        <td class="text-end">@team.TotalPoints</td>
                                    </tr>
                                    rank++;
                                }
                            </tbody>
                        </table>

                        <p class="text-muted mt-3">Waiting for next question...</p>
                    </div>
                </div>
            }
            else
            {
                <div class="card shadow mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Question @(_currentQuestionIndex + 1) - @GetQuestionTypeName()</span>
                        @if (_currentQuestion.Type != QuestionType.Wordle)
                        {
                            <span class="badge @(_timeRemaining <= 5 ? "bg-danger" : "bg-warning text-dark") fs-4">
                                @_timeRemaining s
                            </span>
                        }
                    </div>
                    <div class="card-body">
                        @switch (_currentQuestion.Type)
                        {
                            case QuestionType.MultipleChoice:
                                <MultipleChoiceQuestion
                                    Question="_currentQuestion"
                                    TimeRemaining="_timeRemaining"
                                    HasAnswered="_hasAnswered"
                                    SelectedOption="_selectedOption"
                                    OnAnswerSelected="SubmitMultipleChoiceAnswer" />
                                break;

                            case QuestionType.OpenEnded:
                                <OpenEndedQuestion
                                    Question="_currentQuestion"
                                    TimeRemaining="_timeRemaining"
                                    HasAnswered="_hasAnswered"
                                    SubmittedAnswer="_textAnswer"
                                    AnswerStatus="_answerStatus"
                                    PointsAwarded="_lastAnswer?.PointsAwarded ?? 0"
                                    OnAnswerSubmitted="SubmitTextAnswer" />
                                break;

                            case QuestionType.Wordle:
                                <WordleQuestion
                                    Question="_currentQuestion"
                                    Attempts="_wordleAttempts"
                                    AttemptsUsed="_wordleAttemptsUsed"
                                    IsSolved="_wordleSolved"
                                    IsOutOfAttempts="_wordleOutOfAttempts"
                                    PointsAwarded="_lastAnswer?.PointsAwarded ?? 0"
                                    OnGuessSubmitted="SubmitWordleGuess" />
                                break;
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public string GameCode { get; set; } = string.Empty;
    [Parameter] public Guid TeamId { get; set; }

    private Game? _game;
    private List<Question> _questions = [];
    private Question? _currentQuestion;
    private int _currentQuestionIndex;
    private int _timeRemaining;
    private bool _hasAnswered;
    private int _selectedOption = -1;
    private Answer? _lastAnswer;
    private bool _showingResults;
    private List<TeamScore> _leaderboard = [];
    private HubConnection? _hubConnection;
    private System.Threading.Timer? _timer;

    private string _textAnswer = string.Empty;
    private AnswerStatus _answerStatus = AnswerStatus.Pending;
    private List<WordleAttempt> _wordleAttempts = [];
    private int _wordleAttemptsUsed;
    private bool _wordleSolved;
    private bool _wordleOutOfAttempts;

    protected override async Task OnInitializedAsync()
    {
        _game = await GameService.GetGameByCodeAsync(GameCode);
        if (_game == null)
        {
            Navigation.NavigateTo("/");
            return;
        }

        _questions = await GameService.GetQuestionsAsync();

        _hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/gamehub"))
            .Build();

        _hubConnection.On<int, Question>("QuestionStarted", async (questionIndex, question) =>
        {
            _currentQuestionIndex = questionIndex;
            _currentQuestion = question;
            _timeRemaining = question.TimeLimitSeconds;
            _hasAnswered = false;
            _selectedOption = -1;
            _lastAnswer = null;
            _showingResults = false;
            _textAnswer = string.Empty;
            _answerStatus = AnswerStatus.Pending;
            _wordleAttempts = [];
            _wordleAttemptsUsed = 0;
            _wordleSolved = false;
            _wordleOutOfAttempts = false;

            _timer?.Dispose();
            if (question.Type != QuestionType.Wordle)
            {
                _timer = new System.Threading.Timer(async _ =>
                {
                    _timeRemaining--;
                    if (_timeRemaining <= 0)
                    {
                        _timer?.Dispose();
                    }
                    await InvokeAsync(StateHasChanged);
                }, null, 1000, 1000);
            }

            await InvokeAsync(StateHasChanged);
        });

        _hubConnection.On<Guid, bool, int>("AnswerReviewed", async (teamId, approved, points) =>
        {
            if (teamId == TeamId)
            {
                _answerStatus = approved ? AnswerStatus.Approved : AnswerStatus.Rejected;
                if (_lastAnswer != null)
                {
                    _lastAnswer.IsCorrect = approved;
                    _lastAnswer.PointsAwarded = points;
                }
                await InvokeAsync(StateHasChanged);
            }
        });

        _hubConnection.On<int, List<TeamScore>>("ShowResults", async (questionIndex, leaderboard) =>
        {
            _timer?.Dispose();
            _showingResults = true;
            _leaderboard = leaderboard;
            _lastAnswer = await GameService.GetAnswerAsync(_game!.Id, TeamId, _currentQuestionIndex);
            await InvokeAsync(StateHasChanged);
        });

        _hubConnection.On<List<TeamScore>>("GameEnded", (finalLeaderboard) =>
        {
            Navigation.NavigateTo($"/game/results/{GameCode}/{TeamId}");
        });

        await _hubConnection.StartAsync();
        await _hubConnection.SendAsync("JoinGameGroup", GameCode);

        _game = await GameService.GetGameByCodeAsync(GameCode);
        if (_game == null) return;

        if (_game.CurrentQuestionIndex >= 0 && _game.CurrentQuestionIndex < _questions.Count && _game.QuestionStartedAt.HasValue)
        {
            _currentQuestionIndex = _game.CurrentQuestionIndex;
            _currentQuestion = _questions[_currentQuestionIndex];
            var elapsed = (DateTime.UtcNow - _game.QuestionStartedAt.Value).TotalSeconds;
            _timeRemaining = Math.Max(0, _currentQuestion.TimeLimitSeconds - (int)elapsed);

            var existingAnswer = await GameService.GetAnswerAsync(_game.Id, TeamId, _currentQuestionIndex);
            if (existingAnswer != null)
            {
                _hasAnswered = true;
                _lastAnswer = existingAnswer;
                _selectedOption = existingAnswer.SelectedOptionIndex;
                _textAnswer = existingAnswer.TextAnswer ?? "";
                _answerStatus = existingAnswer.Status;
                _wordleAttempts = existingAnswer.WordleAttempts.OrderBy(a => a.AttemptNumber).ToList();
                _wordleAttemptsUsed = existingAnswer.AttemptsUsed ?? 0;
                _wordleSolved = existingAnswer.IsCorrect && _currentQuestion.Type == QuestionType.Wordle;
                _wordleOutOfAttempts = !_wordleSolved && _wordleAttemptsUsed >= _currentQuestion.MaxAttempts;
            }

            if (_timeRemaining > 0 && _currentQuestion.Type != QuestionType.Wordle)
            {
                _timer = new System.Threading.Timer(async _ =>
                {
                    _timeRemaining--;
                    if (_timeRemaining <= 0)
                    {
                        _timer?.Dispose();
                    }
                    await InvokeAsync(StateHasChanged);
                }, null, 1000, 1000);
            }
        }
    }

    private string GetQuestionTypeName() => _currentQuestion?.Type switch
    {
        QuestionType.MultipleChoice => "Multiple Choice",
        QuestionType.OpenEnded => "Open Answer",
        QuestionType.Wordle => "Wordle",
        _ => "Question"
    };

    private async Task SubmitMultipleChoiceAnswer(int optionIndex)
    {
        if (_hasAnswered || _currentQuestion == null) return;

        _hasAnswered = true;
        _selectedOption = optionIndex;

        _lastAnswer = await GameService.SubmitAnswerAsync(_game!.Id, TeamId, _currentQuestionIndex, optionIndex, _currentQuestion);

        if (_hubConnection != null)
        {
            await _hubConnection.SendAsync("NotifyAnswerSubmitted", GameCode, TeamId);
        }
    }

    private async Task SubmitTextAnswer(string answer)
    {
        if (_hasAnswered || _currentQuestion == null) return;

        _hasAnswered = true;
        _textAnswer = answer;

        _lastAnswer = await GameService.SubmitTextAnswerAsync(_game!.Id, TeamId, _currentQuestionIndex, answer, _currentQuestion);
        _answerStatus = _lastAnswer?.Status ?? AnswerStatus.Rejected;

        if (_hubConnection != null)
        {
            var team = _game!.Teams.FirstOrDefault(t => t.Id == TeamId);
            await _hubConnection.SendAsync("NotifyOpenEndedSubmitted", GameCode, TeamId, team?.Name ?? "Unknown", answer);
        }
    }

    private async Task SubmitWordleGuess(string guess)
    {
        if (_currentQuestion == null || _wordleSolved || _wordleOutOfAttempts) return;

        var (attempt, solved, outOfAttempts) = await GameService.SubmitWordleGuessAsync(
            _game!.Id, TeamId, _currentQuestionIndex, guess, _currentQuestion);

        if (attempt != null)
        {
            _wordleAttempts.Add(attempt);
            _wordleAttemptsUsed = attempt.AttemptNumber;
        }

        _wordleSolved = solved;
        _wordleOutOfAttempts = outOfAttempts;

        if (solved || outOfAttempts)
        {
            _hasAnswered = true;
            _lastAnswer = await GameService.GetAnswerAsync(_game.Id, TeamId, _currentQuestionIndex);
        }

        if (_hubConnection != null)
        {
            await _hubConnection.SendAsync("NotifyWordleProgress", GameCode, TeamId, _wordleAttemptsUsed, solved, outOfAttempts);
        }

        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        _timer?.Dispose();
        if (_hubConnection != null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}

@page "/admin"
@using PubQuiz.Web.Models
@inject GameService GameService
@inject NavigationManager Navigation
@implements IAsyncDisposable
@rendermode InteractiveServer

<PageTitle>Admin - Pause-Quiz</PageTitle>

@if (!_isAuthenticated)
{
    <div class="container">
        <div class="row justify-content-center mt-5">
            <div class="col-md-4">
                <div class="card shadow">
                    <div class="card-body">
                        <h4 class="card-title text-center mb-4">Admin Login</h4>
                        <EditForm Model="@_loginModel" OnValidSubmit="Login">
                            <div class="mb-3">
                                <input type="password" class="form-control" placeholder="Password" @bind="_loginModel.Password" />
                            </div>
                            @if (_loginError)
                            {
                                <div class="alert alert-danger py-2">Invalid password</div>
                            }
                            <button type="submit" class="btn btn-primary w-100">Login</button>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else
{
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Game Administration</h2>
        <div class="d-flex gap-2 align-items-center">
            <a href="/host/login" class="btn btn-success">
                + New Game
            </a>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="autoRefresh" checked="@_autoRefresh" @onchange="ToggleAutoRefresh">
                <label class="form-check-label" for="autoRefresh">Auto-refresh</label>
            </div>
            <button class="btn btn-outline-primary" @onclick="RefreshGames">
                Refresh
            </button>
        </div>
    </div>

    <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <button class="nav-link @(_activeTab == "games" ? "active" : "")" @onclick="@(() => _activeTab = "games")">
                Games
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link @(_activeTab == "questions" ? "active" : "")" @onclick="@(() => _activeTab = "questions")">
                Questions <span class="badge bg-primary">@_questions.Count</span>
            </button>
        </li>
    </ul>

    @if (_activeTab == "games")
    {
        <div class="mb-3">
            <button class="btn btn-sm @(_filter == "active" ? "btn-primary" : "btn-outline-secondary")" @onclick="@(() => SetFilter("active"))">
                Active <span class="badge bg-light text-dark">@_activeGames.Count</span>
            </button>
            <button class="btn btn-sm @(_filter == "all" ? "btn-primary" : "btn-outline-secondary")" @onclick="@(() => SetFilter("all"))">
                All <span class="badge bg-light text-dark">@_allGames.Count</span>
            </button>
        </div>

        @if (_isLoading)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Loading games...</p>
            </div>
        }
        else if (!FilteredGames.Any())
        {
            <div class="alert alert-info">
                No games found.
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Code</th>
                            <th>Status</th>
                            <th>Teams</th>
                            <th>Progress</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var game in FilteredGames)
                        {
                            <tr>
                                <td>
                                    <code class="fs-5">@game.Code</code>
                                </td>
                                <td>
                                    <span class="badge @GetStatusBadgeClass(game.Status)">
                                        @game.Status
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-info">@game.TeamCount teams</span>
                                </td>
                                <td>
                                    @if (game.Status == GameStatus.InProgress)
                                    {
                                        <span>Question @(game.CurrentQuestionIndex + 1) / @_totalQuestions</span>
                                    }
                                    else if (game.Status == GameStatus.Finished)
                                    {
                                        <span class="text-muted">Completed</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Not started</span>
                                    }
                                </td>
                                <td>
                                    <small class="text-muted">@game.CreatedAt.ToLocalTime().ToString("g")</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        @if (game.Status != GameStatus.Finished)
                                        {
                                            <a href="/host/control/@game.Code" class="btn btn-outline-primary" target="_blank">
                                                Control
                                            </a>
                                        }
                                        <button class="btn btn-outline-danger" @onclick="() => DeleteGame(game.Id)">
                                            Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    }
    else if (_activeTab == "questions")
    {
        <div class="row">
            <div class="col-md-8">
                <h5>Current Questions</h5>
                @if (!_questions.Any())
                {
                    <div class="alert alert-info">No questions yet. Add one using the form.</div>
                }
                else
                {
                    <div class="list-group mb-3">
                        @foreach (var (question, index) in _questions.Select((q, i) => (q, i)))
                        {
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="badge bg-secondary me-2">@(index + 1)</span>
                                    <span class="badge @GetQuestionTypeBadge(question.Type) me-2">@question.Type</span>
                                    <strong>@question.Text</strong>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary" @onclick="() => MoveQuestion(question.Id, true)" disabled="@(index == 0)">↑</button>
                                    <button class="btn btn-outline-secondary" @onclick="() => MoveQuestion(question.Id, false)" disabled="@(index == _questions.Count - 1)">↓</button>
                                    <button class="btn btn-outline-danger" @onclick="() => DeleteQuestion(question.Id)">Delete</button>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">Add Question</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Type</label>
                            <select class="form-select" @bind="_newQuestion.Type">
                                <option value="@QuestionType.MultipleChoice">Multiple Choice</option>
                                <option value="@QuestionType.OpenEnded">Open Ended</option>
                                <option value="@QuestionType.Wordle">Wordle</option>
                                <option value="@QuestionType.Estimate">Estimate</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Question Text</label>
                            <input type="text" class="form-control" @bind="_newQuestion.Text" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Time Limit (seconds)</label>
                            <input type="number" class="form-control" @bind="_newQuestion.TimeLimitSeconds" />
                        </div>

                        @if (_newQuestion.Type == QuestionType.MultipleChoice)
                        {
                            <div class="mb-3">
                                <label class="form-label">Options (one per line)</label>
                                <textarea class="form-control" rows="4" @bind="_optionsText"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Correct Option (0-based index)</label>
                                <input type="number" class="form-control" @bind="_newQuestion.CorrectOptionIndex" min="0" />
                            </div>
                        }
                        else if (_newQuestion.Type == QuestionType.OpenEnded)
                        {
                            <div class="mb-3">
                                <label class="form-label">Accepted Answers (one per line)</label>
                                <textarea class="form-control" rows="3" @bind="_acceptedAnswersText"></textarea>
                            </div>
                        }
                        else if (_newQuestion.Type == QuestionType.Wordle)
                        {
                            <div class="mb-3">
                                <label class="form-label">Correct Word (5 letters)</label>
                                <input type="text" class="form-control" @bind="_newQuestion.CorrectAnswer" maxlength="5" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Max Attempts</label>
                                <input type="number" class="form-control" @bind="_newQuestion.MaxAttempts" />
                            </div>
                        }
                        else if (_newQuestion.Type == QuestionType.Estimate)
                        {
                            <div class="mb-3">
                                <label class="form-label">Correct Value</label>
                                <input type="number" class="form-control" @bind="_newQuestion.CorrectValue" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Unit</label>
                                <input type="text" class="form-control" @bind="_newQuestion.Unit" placeholder="e.g. km, kg, CHF" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tolerance %</label>
                                <input type="number" class="form-control" @bind="_newQuestion.TolerancePercent" />
                            </div>
                        }

                        <button class="btn btn-primary w-100" @onclick="AddQuestion">Add Question</button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>
}

@code {
    private bool _isAuthenticated;
    private bool _loginError;
    private LoginModel _loginModel = new();
    private const string AdminPassword = "globi";

    private class LoginModel
    {
        public string Password { get; set; } = "";
    }

    private void Login()
    {
        if (_loginModel.Password == AdminPassword)
        {
            _isAuthenticated = true;
            _loginError = false;
        }
        else
        {
            _loginError = true;
        }
    }

    private List<GameSummary> _allGames = [];
    private List<GameSummary> _activeGames = [];
    private List<Question> _questions = [];
    private bool _isLoading = true;
    private string _filter = "active";
    private string _activeTab = "games";
    private int _totalQuestions;
    private System.Threading.Timer? _refreshTimer;
    private bool _autoRefresh = true;

    private Question _newQuestion = new() { TimeLimitSeconds = 30, MaxAttempts = 6 };
    private string _optionsText = "";
    private string _acceptedAnswersText = "";

    private IEnumerable<GameSummary> FilteredGames => _filter == "active" ? _activeGames : _allGames;

    protected override async Task OnInitializedAsync()
    {
        await RefreshGames();
        _refreshTimer = new System.Threading.Timer(async _ =>
        {
            if (_autoRefresh)
            {
                await RefreshGamesQuiet();
                await InvokeAsync(StateHasChanged);
            }
        }, null, 5000, 5000);
    }

    private async Task RefreshGames()
    {
        _isLoading = true;
        StateHasChanged();

        _questions = await GameService.GetQuestionsAsync();
        _totalQuestions = _questions.Count;

        _allGames = await GameService.GetAllGamesAsync();
        _activeGames = _allGames.Where(g => g.Status != GameStatus.Finished).ToList();

        _isLoading = false;
    }

    private async Task RefreshGamesQuiet()
    {
        _questions = await GameService.GetQuestionsAsync();
        _totalQuestions = _questions.Count;

        _allGames = await GameService.GetAllGamesAsync();
        _activeGames = _allGames.Where(g => g.Status != GameStatus.Finished).ToList();
    }

    private void SetFilter(string filter)
    {
        _filter = filter;
    }

    private void ToggleAutoRefresh()
    {
        _autoRefresh = !_autoRefresh;
    }

    private async Task DeleteGame(Guid gameId)
    {
        await GameService.DeleteGameAsync(gameId);
        await RefreshGames();
    }

    private async Task AddQuestion()
    {
        if (string.IsNullOrWhiteSpace(_newQuestion.Text)) return;

        if (_newQuestion.Type == QuestionType.MultipleChoice)
        {
            _newQuestion.Options = _optionsText.Split('\n', StringSplitOptions.RemoveEmptyEntries).Select(o => o.Trim()).ToList();
        }
        else if (_newQuestion.Type == QuestionType.OpenEnded)
        {
            _newQuestion.AcceptedAnswers = _acceptedAnswersText.Split('\n', StringSplitOptions.RemoveEmptyEntries).Select(a => a.Trim()).ToList();
        }
        else if (_newQuestion.Type == QuestionType.Wordle)
        {
            _newQuestion.CorrectAnswer = _newQuestion.CorrectAnswer?.ToUpper();
        }

        await GameService.AddQuestionAsync(_newQuestion);
        _newQuestion = new Question { TimeLimitSeconds = 30, MaxAttempts = 6 };
        _optionsText = "";
        _acceptedAnswersText = "";
        await RefreshGames();
    }

    private async Task DeleteQuestion(Guid questionId)
    {
        await GameService.DeleteQuestionAsync(questionId);
        await RefreshGames();
    }

    private async Task MoveQuestion(Guid questionId, bool moveUp)
    {
        await GameService.MoveQuestionAsync(questionId, moveUp);
        await RefreshGames();
    }

    private string GetQuestionTypeBadge(QuestionType type) => type switch
    {
        QuestionType.MultipleChoice => "bg-primary",
        QuestionType.OpenEnded => "bg-success",
        QuestionType.Wordle => "bg-warning text-dark",
        QuestionType.Estimate => "bg-info",
        QuestionType.RealOrFake => "bg-danger",
        QuestionType.DinoRun => "bg-dark",
        _ => "bg-secondary"
    };

    private string GetStatusBadgeClass(GameStatus status) => status switch
    {
        GameStatus.Waiting => "bg-warning text-dark",
        GameStatus.InProgress => "bg-success",
        GameStatus.Finished => "bg-secondary",
        _ => "bg-secondary"
    };

    public ValueTask DisposeAsync()
    {
        _refreshTimer?.Dispose();
        return ValueTask.CompletedTask;
    }
}

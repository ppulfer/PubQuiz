@page "/"
@using PubQuiz.Web.Models
@inject GameService GameService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Join Game - Pause-Quiz</PageTitle>

<div class="d-flex align-items-center justify-content-center h-100">
    <div class="card shadow" style="width: 100%; max-width: 500px;">
        <div class="card-body p-4 p-md-5 text-center">
            @if (_savedSession != null)
            {
                <h5 class="mb-3">Active Session Found</h5>
                <p class="mb-1">Team: <strong>@_savedSession.TeamName</strong></p>
                <p class="text-muted mb-4">Game: <strong>@_savedSession.GameCode</strong></p>

                <button class="btn btn-success btn-lg w-100 mb-2" @onclick="Reconnect" disabled="@_isReconnecting">
                    @if (_isReconnecting)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    Reconnect
                </button>
                <button class="btn btn-outline-secondary btn-sm" @onclick="ClearSession">
                    Join Different Game
                </button>

                @if (!string.IsNullOrEmpty(_reconnectError))
                {
                    <div class="alert alert-warning mt-3 mb-0">@_reconnectError</div>
                }
            }
            else if (_gameToJoin == null)
            {
                <h2 class="mb-4">Join Game</h2>

                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <div class="alert alert-danger">@_errorMessage</div>
                }

                <div class="mb-3 text-start">
                    <label class="form-label">Game Code</label>
                    <input type="text" class="form-control form-control-lg text-center text-uppercase"
                           @bind="_gameCode" maxlength="10" placeholder="ABCDE" />
                </div>

                <button class="btn btn-primary btn-lg w-100" @onclick="LookupGame" disabled="@_isJoining">
                    @if (_isJoining)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    Continue
                </button>
            }
            else
            {
                <h2 class="mb-4">Join Game</h2>
                <p class="text-muted mb-3">Game: <strong>@_gameToJoin.Code</strong></p>

                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <div class="alert alert-danger">@_errorMessage</div>
                }

                @if (_gameToJoin.UsePredefinedTeams)
                {
                    <div class="mb-4 text-start">
                        <label class="form-label">Select your Table</label>
                        <select class="form-select form-select-lg" @bind="_selectedTeamId">
                            <option value="">-- Select Table --</option>
                            @foreach (var team in _gameToJoin.Teams.OrderBy(t => t.Name))
                            {
                                <option value="@team.Id">@team.Name</option>
                            }
                        </select>
                    </div>
                }
                else
                {
                    <div class="mb-4 text-start">
                        <label class="form-label">Team Name</label>
                        <input type="text" class="form-control form-control-lg" @bind="_teamName"
                               maxlength="50" placeholder="Your Team Name" />
                    </div>
                }

                <button class="btn btn-primary btn-lg w-100 mb-2" @onclick="JoinGame" disabled="@_isJoining">
                    @if (_isJoining)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    Join Game
                </button>
                <button class="btn btn-outline-secondary btn-sm" @onclick="() => _gameToJoin = null">
                    Back
                </button>
            }
        </div>
    </div>
</div>

@code {
    private string _gameCode = "";
    private string _teamName = "";
    private Guid? _selectedTeamId;
    private PubQuiz.Web.Models.Game? _gameToJoin;
    private string? _errorMessage;
    private string? _reconnectError;
    private bool _isJoining;
    private bool _isReconnecting;
    private TeamSession? _savedSession;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadSavedSession();
            StateHasChanged();
        }
    }

    private async Task LoadSavedSession()
    {
        try
        {
            var gameCode = await JS.InvokeAsync<string?>("localStorage.getItem", "pubquiz_gameCode");
            var teamId = await JS.InvokeAsync<string?>("localStorage.getItem", "pubquiz_teamId");
            var teamName = await JS.InvokeAsync<string?>("localStorage.getItem", "pubquiz_teamName");

            if (!string.IsNullOrEmpty(gameCode) && !string.IsNullOrEmpty(teamId) && !string.IsNullOrEmpty(teamName))
            {
                _savedSession = new TeamSession
                {
                    GameCode = gameCode,
                    TeamId = Guid.Parse(teamId),
                    TeamName = teamName
                };
            }
        }
        catch { }
    }

    private async Task SaveSession(string gameCode, Guid teamId, string teamName)
    {
        await JS.InvokeVoidAsync("localStorage.setItem", "pubquiz_gameCode", gameCode);
        await JS.InvokeVoidAsync("localStorage.setItem", "pubquiz_teamId", teamId.ToString());
        await JS.InvokeVoidAsync("localStorage.setItem", "pubquiz_teamName", teamName);
    }

    private async Task ClearSession()
    {
        await JS.InvokeVoidAsync("localStorage.removeItem", "pubquiz_gameCode");
        await JS.InvokeVoidAsync("localStorage.removeItem", "pubquiz_teamId");
        await JS.InvokeVoidAsync("localStorage.removeItem", "pubquiz_teamName");
        _savedSession = null;
    }

    private async Task Reconnect()
    {
        if (_savedSession == null) return;

        _isReconnecting = true;
        _reconnectError = null;

        try
        {
            var game = await GameService.GetGameByCodeAsync(_savedSession.GameCode);
            if (game == null)
            {
                _reconnectError = "Game no longer exists.";
                await ClearSession();
                return;
            }

            if (game.Status == GameStatus.Finished)
            {
                _reconnectError = "Game has ended.";
                await ClearSession();
                return;
            }

            var team = game.Teams.FirstOrDefault(t => t.Id == _savedSession.TeamId);
            if (team == null)
            {
                _reconnectError = "Team not found in game.";
                await ClearSession();
                return;
            }

            var targetPage = game.Status == GameStatus.Waiting ? "lobby" : "play";
            Navigation.NavigateTo($"/game/{targetPage}/{game.Code}/{team.Id}");
        }
        finally
        {
            _isReconnecting = false;
        }
    }

    private async Task LookupGame()
    {
        _errorMessage = null;
        _isJoining = true;

        try
        {
            if (string.IsNullOrWhiteSpace(_gameCode))
            {
                _errorMessage = "Please enter a game code.";
                return;
            }

            var game = await GameService.GetGameByCodeAsync(_gameCode);
            if (game == null)
            {
                _errorMessage = "Game not found. Please check the code and try again.";
                return;
            }

            if (game.Status == GameStatus.Finished)
            {
                _errorMessage = "This game has already ended.";
                return;
            }

            _gameToJoin = game;
            _selectedTeamId = null;
            _teamName = "";
        }
        finally
        {
            _isJoining = false;
        }
    }

    private async Task JoinGame()
    {
        _errorMessage = null;
        _isJoining = true;

        try
        {
            if (_gameToJoin == null) return;

            Team? team;
            if (_gameToJoin.UsePredefinedTeams)
            {
                if (!_selectedTeamId.HasValue)
                {
                    _errorMessage = "Please select a table.";
                    return;
                }
                team = _gameToJoin.Teams.FirstOrDefault(t => t.Id == _selectedTeamId.Value);
                if (team == null)
                {
                    _errorMessage = "Invalid table selected.";
                    return;
                }
            }
            else
            {
                if (string.IsNullOrWhiteSpace(_teamName))
                {
                    _errorMessage = "Please enter a team name.";
                    return;
                }
                team = await GameService.JoinGameAsync(_gameToJoin.Id, _teamName);
            }

            await SaveSession(_gameToJoin.Code, team.Id, team.Name);
            Navigation.NavigateTo($"/game/lobby/{_gameToJoin.Code}/{team.Id}");
        }
        finally
        {
            _isJoining = false;
        }
    }

    private class TeamSession
    {
        public string GameCode { get; set; } = string.Empty;
        public Guid TeamId { get; set; }
        public string TeamName { get; set; } = string.Empty;
    }
}
